# 共有インフラストラクチャ

## 概要

共有インフラストラクチャは、すべての境界づけられたコンテキストが利用する技術的な基盤を提供します。これには永続化、メッセージング、横断的関心事などが含まれます。

## アーキテクチャ原則

### 1. レイヤー分離

- **ドメイン層**: ビジネスロジックに集中、インフラストラクチャに依存しない
- **インフラストラクチャ層**: 技術的関心事を扱い、ドメイン層のインターフェースを実装
- **明確な境界**: トレイトによる抽象化で依存関係を逆転

### 2. 設定の外部化

- 環境変数による設定
- シークレット管理（Cloud Secret Manager）
- 環境別の設定ファイル

### 3. テスタビリティ

- インターフェースによる抽象化
- モック可能な設計
- インメモリ実装の提供

## 主要コンポーネント

### Event Store

**責務**: イベントソーシングのための永続化層

**機能**:

- イベントの追加（アペンド専用）
- イベントストリームの読み取り
- スナップショット管理
- 楽観的ロック制御

**実装**: `shared/infrastructure/event_store/`

**設計判断**:

- PostgreSQL を選択（トランザクション保証とJSON サポート）
- イベントは不変（更新・削除不可）
- ストリーム単位でのバージョン管理
- EventStore はインフラストラクチャ層にのみ存在（ドメイン層には含めない）

### Event Bus

**責務**: コンテキスト間の非同期メッセージング

**機能**:

- イベントの発行（publish）
- イベントの購読（subscribe）
- At-least-once デリバリー保証
- 自動リトライとDLQ

**実装**: `shared/infrastructure/event_bus/`

**設計判断**:

- Google Pub/Sub を選択（マネージドサービス、スケーラビリティ）
- トピック自動作成
- JSON シリアライズ

### Repository 基底実装

**責務**: 一般的なCRUD操作の抽象化

**機能**:

- 基本的なCRUD操作
- ページネーション
- ソフトデリート
- 楽観的ロック

**実装**: `shared/infrastructure/repository/`

**設計判断**:

- トレイトベースの設計
- SQLx による型安全なクエリ
- 自動的なタイムスタンプ管理

### データベース接続管理

**責務**: データベース接続プールとトランザクション管理

**機能**:

- 接続プール管理
- トランザクション境界制御
- ヘルスチェック
- 自動再接続

**実装**: `shared/infrastructure/database/`

**設計判断**:

- SQLx を使用（コンパイル時クエリ検証）
- 環境別の接続設定
- 接続プールサイズの調整可能

## 横断的関心事

### エラー処理

**方針**:

- ドメインエラーとインフラストラクチャエラーの分離
- エラーの伝播と変換
- 構造化されたエラー情報

**実装**: `shared/cross_cutting/error/`

### セキュリティ

**方針**:

- 認証・認可の一元管理
- シークレットの安全な管理
- 監査ログの自動記録

**実装**: `shared/cross_cutting/security/`

### 観測性

**方針**:

- 構造化ログ
- 分散トレーシング
- メトリクス収集

**実装**: `shared/cross_cutting/telemetry/`

### キャッシュ

**方針**:

- Redis による分散キャッシュ
- キャッシュ戦略の設定可能
- 自動的な無効化

**実装**: `shared/cross_cutting/cache/`

## 依存関係管理

### 依存の方向

```
Domain Layer
    ↑
    | (implements)
    |
Infrastructure Layer
    ↑
    | (uses)
    |
External Systems
```

### 依存性注入

- コンストラクタインジェクション
- トレイトオブジェクトによる実行時バインディング
- ファクトリパターンによる生成

## パフォーマンス考慮事項

### 接続プーリング

- データベース: 最小10、最大100接続
- Redis: 接続プール使用
- gRPC: 接続の再利用

### 非同期処理

- async/await による非同期I/O
- Tokio ランタイム
- 適切なタイムアウト設定

### バッチ処理

- イベントの一括保存
- クエリの最適化
- ページネーションの活用

## 運用考慮事項

### ヘルスチェック

各インフラストラクチャコンポーネントは以下を提供：

- Liveness チェック（プロセスの生存確認）
- Readiness チェック（サービス提供可能状態）
- 依存サービスの確認

### モニタリング

- ログ: Cloud Logging
- メトリクス: Cloud Monitoring
- トレース: Cloud Trace
- アラート設定

### バックアップとリカバリ

- Event Store: 定期的なバックアップ
- スナップショット: 長期保存
- ポイントインタイムリカバリ

## 技術スタック

### 採用技術

- **言語**: Rust (Edition 2024)
- **非同期ランタイム**: Tokio
- **データベース**: PostgreSQL 15+
- **キャッシュ**: Redis 7+
- **メッセージング**: Google Pub/Sub
- **検索**: Meilisearch
- **監視**: OpenTelemetry

### 主要ライブラリ

- `sqlx`: データベースアクセス
- `tonic`: gRPC 実装
- `serde`: シリアライズ
- `tracing`: ログとトレース
- `thiserror`: エラー処理

## 関連ドキュメント

- [Shared Kernel](shared-kernel.md)
- [Event Sourcing ガイドライン](event-sourcing-guidelines.md)
- [横断的関心事](cross-cutting-concerns.md)
- [技術的負債](technical-debt.md)

## 更新履歴

- 2025-08-05: 初版作成
