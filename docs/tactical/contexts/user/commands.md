# User Context - コマンド設計

## 概要

User Context で実行可能なコマンド（書き込み操作）の定義です。シンプルさを重視し、必要最小限のコマンドのみを定義しています。

## コマンド一覧

| コマンド名 | 説明 | 実行権限 |
|-----------|------|----------|
| SignUpUser | 新規ユーザー登録 | 未認証可 |
| UpdateProfile | プロファイル更新 | 本人のみ |
| UpdateLearningGoal | 学習目標の更新 | 本人のみ |
| ChangeUserRole | ユーザーロール変更 | Admin のみ |
| DeleteAccount | アカウント削除 | 本人または Admin |

## コマンド詳細

### 1. SignUpUser

新規ユーザーを登録するコマンド。初回認証時に自動実行される。

**コマンド構造**:

- id_token: 認証プロバイダーからの ID トークン

**処理フロー**:

1. ID トークンを検証
2. 認証プロバイダーからユーザー情報取得
3. 既存ユーザーチェック
4. 新規ユーザー作成
5. UserCreated イベント発行

**バリデーション**:

- 有効な ID トークン
- メールアドレスの形式
- 重複ユーザーチェック

**レスポンス**:

- user_id: 新規作成されたユーザー ID
- access_token: アクセストークン
- refresh_token: リフレッシュトークン

### 2. UpdateProfile

ユーザープロファイルを更新するコマンド。

**コマンド構造**:

- user_id: 対象ユーザー ID
- display_name: 表示名（オプション）
- photo_url: プロフィール画像 URL（オプション）
- difficulty_preference: 難易度設定（オプション）
- version: 楽観的ロック用バージョン番号

**処理フロー**:

1. ユーザー存在確認
2. 権限チェック（本人のみ）
3. バージョンチェック
4. プロファイル更新
5. UserProfileUpdated イベント発行

**バリデーション**:

- 本人認証
- display_name: 1-50文字
- photo_url: 有効な URL 形式
- difficulty_preference: A1-C2 の範囲

**エラーケース**:

- `NotFound`: ユーザーが存在しない
- `Forbidden`: 他人のプロファイル更新
- `Conflict`: バージョン不一致

### 3. UpdateLearningGoal

学習目標を更新するコマンド。

**コマンド構造**:

- user_id: 対象ユーザー ID
- learning_goal: 学習目標（IELTS スコア、CEFR レベル、または目標なし）
- version: 楽観的ロック用バージョン番号

**学習目標の種類**:

- IELTS スコア: 4.0 - 9.0
- CEFR レベル: A1 - C2
- 特定の目標なし

**処理フロー**:

1. ユーザー存在確認
2. 権限チェック（本人のみ）
3. 目標値の妥当性チェック
4. 学習目標更新
5. UserProfileUpdated イベント発行

**バリデーション**:

- IELTS スコア: 4.0 - 9.0 の範囲
- CEFR レベル: 有効な値

### 4. ChangeUserRole

ユーザーのロールを変更するコマンド（Admin 専用）。

**コマンド構造**:

- target_user_id: 対象ユーザー ID
- new_role: 新しいロール（Admin/User）
- changed_by: 変更実行者のユーザー ID
- reason: 変更理由（オプション）

**処理フロー**:

1. 実行者の Admin 権限確認
2. 対象ユーザー存在確認
3. 自分自身でないことを確認
4. ロール変更
5. UserRoleChanged イベント発行

**バリデーション**:

- 実行者が Admin
- 自分自身のロールは変更不可
- 最低1人の Admin が必要

**エラーケース**:

- `Forbidden`: Admin 権限なし
- `InvalidOperation`: 自分自身のロール変更
- `LastAdmin`: 最後の Admin は降格不可

### 5. DeleteAccount

アカウントを削除するコマンド（論理削除）。

**コマンド構造**:

- user_id: 削除対象ユーザー ID
- deleted_by: 削除実行者のユーザー ID
- deletion_type: 削除タイプ（本人削除/Admin削除）
- reason: 削除理由（オプション）

**削除タイプ**:

- SelfDeletion: 本人による削除
- AdminDeletion: Admin による削除

**処理フロー**:

1. 権限チェック（本人または Admin）
2. ユーザー存在確認
3. deleted_at を設定（論理削除）
4. UserDeleted イベント発行
5. カスケード削除の開始

**バリデーション**:

- 本人または Admin のみ実行可能
- 既に削除済みでないこと

**注意事項**:

- 物理削除は行わない
- deleted_at フィールドで管理
- 他コンテキストへのカスケード削除通知

## トランザクション管理

すべてのコマンドはトランザクション内で実行され、成功時にコミット、失敗時にロールバックされます。これにより、データの一貫性が保証されます。

## エラーハンドリング

### 主要なエラー型

| エラー型 | 説明 | 発生条件 |
|---------|------|----------|
| NotFound | リソースが見つからない | ユーザーが存在しない場合 |
| Forbidden | 操作が禁止されている | 権限不足の場合 |
| Conflict | バージョン競合 | 楽観的ロックの失敗 |
| ValidationError | 入力値が不正 | バリデーション失敗 |
| AlreadyExists | 既に存在する | 重複登録の試行 |
| InvalidOperation | 無効な操作 | ビジネスルール違反 |

## 実装上の注意事項

1. **べき等性**: 同じコマンドを複数回実行しても安全
2. **楽観的ロック**: version フィールドによる同時更新制御
3. **権限チェック**: すべてのコマンドで適切な権限確認
4. **イベント発行**: 成功時は必ずドメインイベントを発行
