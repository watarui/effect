# AI Integration Context - コマンド

## 概要

AI Integration Context のコマンドは、AI タスクの作成、処理、管理を担当します。すべてのコマンドは非同期処理を前提とし、タスクキューを通じて実行されます。

## 主要コマンド

### 1. CreateGenerationTask

**目的**: AI 生成タスクを作成してキューに追加

**パラメータ**:

- task_type: "text_generation" | "image_generation" | "chat_completion"
- request_content: 生成要求の内容
- requested_by: 要求元コンテキスト
- priority: 優先度（オプション）
- metadata: 追加メタデータ

**処理内容**:

- タスク ID の生成
- Redis キューへの追加
- 即座のタスク ID 返却
- 初期ステータスイベントの発行

### 2. ProcessTask

**目的**: キューからタスクを取得して処理

**パラメータ**:

- worker_id: ワーカー識別子
- max_processing_time: 最大処理時間

**処理内容**:

- キューからタスクを claim
- 適切なプロバイダー選択
- AI API の呼び出し
- 結果の保存
- 完了通知の送信

### 3. RetryTask

**目的**: 失敗したタスクを再試行

**パラメータ**:

- task_id: タスク識別子
- retry_reason: 再試行理由
- delay: 遅延時間（オプション）

**処理内容**:

- リトライ回数のチェック
- バックオフ計算
- キューへの再追加
- リトライイベントの発行

### 4. CancelTask

**目的**: 実行中または待機中のタスクをキャンセル

**パラメータ**:

- task_id: タスク識別子
- cancellation_reason: キャンセル理由

**処理内容**:

- タスクステータスの確認
- 処理中の場合は中断シグナル送信
- キューからの削除
- キャンセル通知の送信

### 5. StartChatSession

**目的**: 深掘りチャットセッションを開始

**パラメータ**:

- user_id: ユーザー識別子
- item_id: 対象項目識別子
- initial_context: 初期コンテキスト

**処理内容**:

- セッション ID の生成
- コンテキストの準備
- セッション情報の保存
- 開始通知の送信

### 6. SendChatMessage

**目的**: チャットセッションにメッセージを送信

**パラメータ**:

- session_id: セッション識別子
- message: ユーザーメッセージ
- include_context: コンテキスト更新（オプション）

**処理内容**:

- セッションの検証
- メッセージ履歴の更新
- AI レスポンス生成タスクの作成
- リアルタイム応答の送信

### 7. CloseChatSession

**目的**: チャットセッションを終了

**パラメータ**:

- session_id: セッション識別子
- close_reason: 終了理由

**処理内容**:

- セッション状態の更新
- リソースの解放
- 統計情報の記録
- 終了通知の送信

## バッチ処理コマンド

### ProcessPendingTasks

**実行タイミング**: 継続的（ワーカープール）

**処理内容**:

- 待機中タスクの取得
- 並列処理の実行
- 結果の集約

### CleanupTimedOutTasks

**実行タイミング**: 5分間隔

**処理内容**:

- タイムアウトタスクの特定
- 失敗ステータスへの更新
- リトライまたは DLQ への移動

### ProcessDeadLetterQueue

**実行タイミング**: 30分間隔

**処理内容**:

- DLQ タスクの確認
- 手動レビューのマーキング
- 可能な場合は自動リトライ

## プロバイダー管理コマンド

### SwitchProvider

**目的**: 障害時のプロバイダー切り替え

**パラメータ**:

- from_provider: 現在のプロバイダー
- to_provider: 切り替え先
- reason: 切り替え理由

**処理内容**:

- Circuit Breaker の確認
- 優先順位の更新
- 進行中タスクの移行

### UpdateProviderConfig

**目的**: プロバイダー設定の更新

**パラメータ**:

- provider: プロバイダー名
- config: 新しい設定

**処理内容**:

- 設定の検証
- 接続テスト
- 設定の適用

## エラー処理

### 一時的エラー

- 自動リトライ対象
- 指数バックオフ適用
- 最大3回まで再試行

### 永続的エラー

- Dead Letter Queue へ移動
- エラー通知の送信
- 手動介入の要求

### タイムアウト

- 設定時間（5分）で強制終了
- タイムアウトイベントの発行
- オプションでリトライ
