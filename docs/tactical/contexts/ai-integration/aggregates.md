# AI Integration Context - 集約設計

## 概要

AI Integration Context は外部 AI サービスへの統合ゲートウェイとして機能し、Anti-Corruption Layer パターンにより内部ドメインを保護します。

## 集約の設計

### 1. AIGenerationTask（AI 生成タスク）

**目的**: AI 生成タスクのライフサイクル管理

**主要属性**:

- タスク識別子とステータス
- タスクタイプ（テキスト生成、画像生成、チャット）
- リクエスト/レスポンス情報
- リトライ管理

**不変条件**:

- 完了タスクの不変性
- リトライ回数の上限（3回）
- 処理中のみキャンセル可能

### 2. ChatSession（チャットセッション）

**目的**: 深掘りチャットの会話管理

**主要属性**:

- セッション情報（ID、ユーザー、対象項目）
- 会話履歴とコンテキスト
- タイムアウト管理

**セッション管理**:

- 30分間の自動タイムアウト
- 最大50メッセージの履歴保持
- 項目情報と学習履歴のコンテキスト

## ドメインサービス

### AIServiceAdapter

**目的**: 外部 AI サービスの抽象化

**責務**:

- プロバイダー選択と切り替え
- API フォーマット変換
- エラーハンドリング
- レート制限管理

**サポートプロバイダー**:

- Gemini（第一選択）
- OpenAI GPT-5（第二選択）  
- Claude（第三選択）
- 無料画像素材サービス

## 設計上の重要な決定

### 非同期処理

- タスク ID の即座返却
- バックグラウンド処理
- イベント駆動の完了通知

### Anti-Corruption Layer

- プロバイダー API の抽象化
- 内部モデルへの変換
- 統一エラーハンドリング

### エラー回復

- Circuit Breaker（5回失敗で遮断）
- 指数バックオフ
- プロバイダーフォールバック

### コスト管理  

- 月次使用量制限
- トークン数事前計算
- 優先度ベース処理
