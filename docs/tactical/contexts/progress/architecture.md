# Progress Context - アーキテクチャ

## 概要

Progress Context は純粋な CQRS/Event Sourcing アーキテクチャを採用し、学習活動の完全な履歴を保持して様々な角度から進捗を可視化します。

## アーキテクチャパターン

### CQRS/Event Sourcing

Progress Context の特徴：

- **Write Model なし**: 集約を持たず、他コンテキストのイベントを受信するのみ
- **Read Model 専用**: すべてのデータはイベントから導出される投影
- **Event Store**: すべてのイベントを時系列で永続化
- **結果整合性**: リアルタイム性より正確性を優先

### 3サービス構成

```
┌─────────────────────────────────────────────────┐
│           progress-command-service              │
│  - イベント受信                                 │
│  - Event Store への永続化                       │
│  - イベント順序保証                             │
└─────────────────────────────────────────────────┘
                        │
                    Pub/Sub
                        │
      ┌─────────────────┴─────────────────┐
      ↓                                   ↓
┌──────────────────────┐    ┌──────────────────────┐
│ progress-query-service │    │ progress-projection-service │
│ - GraphQL API         │    │ - イベント消費        │
│ - Read Model 読み取り │    │ - 投影の更新          │
│ - キャッシング        │    │ - 統計集計           │
└──────────────────────┘    └──────────────────────┘
```

## データフロー

### イベント受信から投影更新まで

1. **イベント受信**: 他コンテキストからのドメインイベント
2. **永続化**: Event Store へ追記
3. **配信**: Pub/Sub 経由で projection-service へ
4. **投影更新**: 各種 Read Model を更新
5. **クエリ提供**: GraphQL 経由でフロントエンドへ

## 投影（Read Model）設計

### 主要な投影

| 投影名 | 更新タイミング | 用途 |
|--------|--------------|------|
| DailyStats | リアルタイム | 日別学習統計 |
| WeeklyStats | 5分バッチ | 週別傾向分析 |
| ItemStats | リアルタイム | 項目別進捗 |
| DomainStats | 5分バッチ | R/W/L/S別統計 |
| LevelStats | 5分バッチ | CEFR レベル別 |
| StreakProjection | リアルタイム | 連続学習記録 |

### 更新戦略

**リアルタイム更新**:

- ユーザー体験に直結する統計
- SessionCompleted イベント受信時に即座に更新

**バッチ更新**:

- 集計コストの高い統計
- 5分間隔で差分更新

**遅延評価**:

- アクセス頻度の低い統計
- クエリ時に動的生成

## イベントソーシングの利点

### 完全な監査証跡

- すべての学習活動が記録される
- 過去の任意時点の状態を再現可能

### 柔軟な拡張性

- 新しい統計視点を後から追加可能
- 既存データから新しい投影を生成

### 障害からの復旧

- イベントから状態を完全に再構築可能
- データ不整合のリスクを排除

## パフォーマンス最適化

### キャッシング戦略

- Redis による GraphQL レスポンスキャッシュ
- 頻繁にアクセスされる統計の事前計算

### イベント処理

- 並列処理による高速化
- スナップショットによる再構築時間短縮

### スケーラビリティ

- 読み取り負荷: query-service の水平スケーリング
- 書き込み負荷: projection-service の並列度調整

## 技術スタック

| コンポーネント | 技術選定 | 理由 |
|--------------|---------|------|
| Event Store | PostgreSQL | ACID特性、JSON サポート |
| Message Bus | Google Pub/Sub | 信頼性、スケーラビリティ |
| Read Model | PostgreSQL | 複雑なクエリ対応 |
| Cache | Redis | 高速アクセス |
| API | GraphQL | 柔軟なクエリ |
| Runtime | Google Cloud Run | サーバーレス、自動スケーリング |

## 設計原則

### イミュータビリティ

- イベントは追記のみ
- 過去のイベントは変更不可

### 結果整合性

- 即座の一貫性より最終的な正確性を優先
- ユーザーは若干の遅延を許容

### 可観測性

- すべてのイベント処理を追跡可能
- メトリクスとログによる監視
