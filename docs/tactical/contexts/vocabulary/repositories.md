# Vocabulary Context - リポジトリ設計

## 概要

Vocabulary Context には 2 つの集約が存在し、それぞれに対応するリポジトリを定義します：

- `VocabularyEntry`：語彙エントリ（スペリング単位の管理）
- `VocabularyItem`：語彙項目（意味や品詞単位の詳細情報）

## VocabularyEntryRepository

語彙エントリの永続化を担当するリポジトリです。

### 主要な責務

- エントリの基本的な CRUD 操作
- スペリングによる検索
- キーワード検索とオートコンプリート
- AI 生成関連のクエリ
- 統計情報の取得

### インターフェース設計

**基本的な CRUD 操作**:

- `find_by_id`: ID でエントリを取得
- `find_by_spelling`: スペリングでエントリを取得
- `save`: エントリを保存（新規作成または更新）
- `delete`: エントリを削除（論理削除推奨）

**検索関連のクエリ**:

- `search`: キーワードでエントリを検索
- `find_by_prefix`: プレフィックス検索（オートコンプリート用）
- `find_all_paginated`: 全エントリをページネーションで取得

**AI 生成関連**:

- `find_failed_generation_entries`: AI 生成失敗のエントリを取得（リトライ用）

**統計関連**:

- `count_total`: エントリ総数を取得
- `count_generated`: AI 生成済みエントリ数を取得

## VocabularyItemRepository

語彙項目の詳細情報の永続化を担当するリポジトリです。

### 主要な責務

- 項目の基本的な CRUD 操作
- エントリに紐づく項目の管理
- 楽観的ロックによる同時更新制御
- バージョン管理
- ステータス別のクエリ
- タグによる検索

### インターフェース設計

**基本的な CRUD 操作**:

- `find_by_id`: ID で項目を取得
- `find_by_entry_id`: エントリ ID に紐づく全項目を取得
- `save`: 項目を保存（新規作成または更新）
- `delete`: 項目を削除（論理削除推奨）

**楽観的ロックサポート**:

- `find_by_id_with_version`: ID とバージョンで項目を取得
- `update_with_version`: バージョンチェック付きで更新

**バッチ操作**:

- `find_by_ids`: 複数の ID で項目を一括取得
- `save_batch`: 複数の項目を一括保存

**検索関連のクエリ**:

- `search`: キーワードで項目を検索
- `find_by_status`: ステータスで項目を検索
- `find_by_tag`: タグで項目を検索
- `find_by_cefr_level`: CEFR レベルで項目を検索

**AI 生成関連**:

- `find_pending_ai`: AI 生成待ちの項目を取得
- `find_failed_generation`: AI 生成失敗の項目を取得

**統計関連**:

- `count_by_status`: ステータス別の項目数を取得
- `count_by_entry_id`: エントリ ID に紐づく項目数を取得
- `generate_statistics`: 語彙統計を生成

## 実装上の考慮事項

### トランザクション境界

- 各リポジトリメソッドは単一のトランザクション内で実行
- 複数の集約を跨ぐ操作は、アプリケーションサービス層でトランザクションを管理

### 楽観的ロック

- `VocabularyItem` の更新時は必ずバージョンチェックを実施
- 競合発生時は `UpdateConflicted` イベントを発行

### キャッシング戦略

- 読み取り頻度の高いエントリはキャッシュを考慮
- 更新時はキャッシュの無効化を確実に実施

### パフォーマンス最適化

- 検索クエリはインデックスを活用
- バッチ操作で N+1 問題を回避
- ページネーションで大量データの取得を制御

### エラーハンドリング

- リポジトリ層でのエラーは適切な型に変換
- データベース固有のエラーをドメインエラーにマッピング
