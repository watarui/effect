# 統合パターン

## 概要

このドキュメントでは、Effect の各境界づけられたコンテキスト間の統合パターンについて詳細に説明します。

## 統合パターン一覧

### 1. Shared Kernel（共有カーネル）

**使用箇所**: User Context ↔ 他のすべてのコンテキスト

**特徴**:

- 小さく安定した共有モデル
- 変更時は全チームの合意が必要
- 密結合だが管理可能な範囲

### 2. Published Language（公開ホスト言語）

**使用箇所**: Word Management → Learning Context

**特徴**:

- 明確に定義された API
- バージョニング対応
- ドキュメント化された仕様

### 3. Domain Events（ドメインイベント）

**使用箇所**: Learning Context → Progress Context

**特徴**:

- 非同期通信
- 疎結合
- イベントソーシング対応

### 4. Anti-Corruption Layer（腐敗防止層）

**使用箇所**: 外部システムとの統合

**特徴**:

- 外部モデルからの保護
- 変換ロジックの集約
- テスト可能性の向上

## 詳細な実装パターン

### Shared Kernel の実装

**概念**: 複数のコンテキスト間で共有される基本的な型定義。

**含まれるもの**:

- 識別子（UserId、ItemId など）
- 基本的な値オブジェクト（CourseType、CefrLevel など）
- 共通のタイムスタンプ表現

**実装場所**: `shared/kernel/src/`

**設計原則**:

- 最小限の共有
- ビジネスロジックを含まない
- 高い安定性

### Published Language の実装

**概念**: コンテキストが外部に公開する明確に定義された API。

**特徴**:

- 明確なインターフェース定義
- バージョニング対応
- ドキュメント化された仕様
- 後方互換性の維持

**実装方法**:

- gRPC サービス定義（`.proto` ファイル）
- GraphQL スキーマ
- REST API 仕様

**実装場所**: `protos/services/`

**設計原則**:

- 安定したインターフェース
- 明確なバージョニング戦略
- 包括的なドキュメント

### Domain Events の実装

**概念**: コンテキスト間の非同期通信を実現するイベント駆動アーキテクチャ。

**メリット**:

- 疎結合な通信
- 時間的な分離
- イベントソーシング対応
- 監査ログの自動生成

**実装方法**:

1. **イベント定義**: 各コンテキストでドメインイベントを定義
2. **イベントバス**: Pub/Sub によるイベント配信
3. **イベントストア**: イベントの永続化と再生

**実装場所**:

- イベント定義: `shared/contexts/*/src/events.rs`
- イベントバス: `shared/infrastructure/event_bus/`
- イベントストア: `shared/infrastructure/event_store/`

**設計原則**:

- イベントは過去形で命名
- イベントは不変
- 必要最小限の情報のみ含む

### Anti-Corruption Layer の実装

**概念**: 外部システムのモデルから内部ドメインモデルを保護する変換層。

**目的**:

- 外部システムの変更から内部を保護
- ドメインモデルの純粋性を維持
- 変換ロジックの一元化

**実装パターン**:

1. **Adapter**: 外部 API との通信
2. **Translator**: データ形式の変換
3. **Facade**: 複雑な外部システムの簡略化

**実装場所**: 各サービスの `infrastructure/external/`

**設計原則**:

- 外部モデルを内部に漏らさない
- 変換は明示的に行う
- エラーハンドリングを適切に行う

## 統合テスト戦略

### Contract Testing

**目的**: API の契約（仕様）が守られていることを保証。

**テスト対象**:

- Published Language のインターフェース
- イベントスキーマ
- エラーレスポンス形式

### Integration Testing

**目的**: コンテキスト間の連携が正しく動作することを確認。

**テスト項目**:

- イベントフローの検証
- データ整合性の確認
- エラー伝播の検証

### テスト環境

- **単体テスト**: モック/スタブを使用
- **統合テスト**: Docker Compose による環境構築
- **E2E テスト**: 本番環境に近い構成

## マイグレーション戦略

### 現在の構成: マイクロサービス

Effect プロジェクトは最初からマイクロサービスアーキテクチャを採用：

- **独立したサービス**: 各コンテキストが独立したサービスとして実装
- **gRPC 通信**: サービス間は gRPC で通信
- **イベント駆動**: Pub/Sub によるイベント配信
- **コンテナ化**: Docker による環境構築

### 段階的な実装アプローチ

1. **Phase 1**: コアドメインの実装（Vocabulary Context）
2. **Phase 2**: 周辺コンテキストの追加
3. **Phase 3**: 統合とオーケストレーション

### インフラストラクチャ

- **ローカル開発**: Docker Compose
- **本番環境**: Google Cloud Run + Cloud Pub/Sub

## 更新履歴

- 2025-07-25: 初版作成
