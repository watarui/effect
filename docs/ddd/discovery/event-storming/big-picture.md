# EventStorming - Big Picture

## セッション情報

- **日付**: 2025-07-27
- **参加者**: ドメインエキスパート（ユーザー）、AI アシスタント
- **目的**: Effect の実際のビジネスフローを理解し、主要なイベントを特定する

## タイムライン

### 1. 初回利用フロー

```
[Googleアカウントで認証された] → [ユーザーアカウントが作成された]
                                        ↓
                            [学習コースが選択された]（例：IELTSコース）
                                        ↓
                            [目標スコアが設定された]（例：7.0）
                                        ↓
                            [初期セットアップが完了した]
```

### 2. 日々の学習フロー（25分ポモドーロ）

```
[アプリが開かれた] → [メイン画面が表示された]
        ↓
[復習が選択された] → [復習テストが開始された] → [語句が表示された]
                                            ↓
                                    [制限時間バーが開始された]
                                            ↓
                        [ユーザーが反応した]（わかる/わからない/曖昧）
                                            ↓
                            [反応時間が記録された] → [結果が評価された]
                                                        ↓
                                                [次の語句が表示された]
                                                        ↓
                                                    ... (10問繰り返し)
                                                        ↓
                                            [テストセッションが完了した]
                                                        ↓
                                            [学習統計が更新された]
```

### 3. 語句管理フロー

```
[語句登録が選択された] → [新しい語句が入力された]
                                ↓
                    [AIに語句情報生成が要求された]
                                ↓
                    [語句情報が生成された]（意味、例文、発音記号）
                                ↓
                    [グローバル辞書に保存された]
                                ↓
                    [ユーザーの学習リストに追加された]
```

### 4. AI深掘りフロー

```
[語句詳細ページが開かれた] → [AI深掘りが要求された]
                                    ↓
                        [AIとのチャットセッションが開始された]
                                    ↓
                        [語句に関する質問が送信された]
                                    ↓
                        [AIが詳細説明を返答した]
```

### 5. 進捗確認フロー

```
[進捗画面が開かれた] → [学習データが集計された]
                            ↓
                    [領域別スコアが計算された]（R/W/L/S）
                            ↓
                    [レーダーチャートが生成された]
                            ↓
                    [IELTSスコアが推定された]
```

### 6. AIカスタムテストフロー

```
[テスト開始時] → [AIへの指示が入力された]（例："Speaking語句多めで"）
                        ↓
                [AIがテスト内容を生成した]
                        ↓
                [カスタマイズされたテストが開始された]
```

## 主要なドメインイベント

### 🟠 ドメインイベント（オレンジ付箋）

#### User Context

- Googleアカウントで認証された
- ユーザーアカウントが作成された
- 学習コースが選択された
- 目標スコアが設定された

#### Learning Context

- 復習テストが開始された
- 項目が表示された
- 制限時間バーが開始された
- ユーザーが反応した（わかる/わからない/曖昧）
- 反応時間が記録された
- 結果が評価された
- テストセッションが完了した
- 項目が「覚えた」と判定された

#### Learning Algorithm Context

- 復習間隔が計算された
- 難易度係数が更新された
- 次回復習日が決定された
- 学習統計が更新された

#### Vocabulary Context（グローバル辞書）

- 新しい語句が入力された
- AIに語句情報生成が要求された
- 語句情報が生成された
- グローバル辞書に保存された
- ユーザーの学習リストに追加された

#### AI Integration Context

- AI深掘りが要求された
- AIとのチャットセッションが開始された
- 語句に関する質問が送信された
- AIが詳細説明を返答した
- AIへのテストカスタマイズ指示が送信された
- AIがテスト内容を生成した

#### Progress Context

- 学習データが集計された
- 領域別スコアが計算された（R/W/L/S）
- レーダーチャートが生成された
- IELTSスコアが推定された

## ホットスポット 🔥

### 1. 「覚えた」判定の精度

**課題**: どの程度素早く「わかる」を押せば「覚えた」とするか
**考慮点**: 反応時間の閾値、連続正解数、忘却曲線の考慮

### 2. グローバル辞書の品質管理

**課題**: AI生成の語句情報の精度と一貫性
**考慮点**: 複数ユーザーが同じ語句を登録した場合の処理

### 3. テストの出題アルゴリズム

**課題**: 「覚えた」語句をいつ再度出題するか
**考慮点**: SM-2アルゴリズムとAIの組み合わせ

### 4. 領域別（R/W/L/S）の判定

**課題**: 語句をどの領域に分類するか
**考慮点**: 一つの語句が複数領域に関連する場合

## 外部システムとの連携

### 📥 入力

- Firebase Auth + Google OAuth
- OpenAI API / Gemini API（項目情報生成、深掘り、スコア推定）

### 📤 出力

- 学習データのエクスポート（将来的に）

## ポリシー（ビジネスルール）

### 💡 主要なポリシー

1. **「覚えた」判定ポリシー**
   - 「わかる」ボタンを3秒以内に押し、かつ過去3回連続正解
   - トリガー: ユーザーが反応した

2. **復習間隔ポリシー**
   - 「覚えた」項目は初回7日後、その後は前回間隔の2.5倍で再出題
   - トリガー: 項目が「覚えた」と判定された

3. **テスト構成ポリシー**
   - 復習項目を優先し、余裕があれば新規項目を追加
   - 1セッション10問、各問30秒制限
   - トリガー: テストが開始された

4. **AI利用ポリシー**
   - 項目情報生成は必須項目（意味、例文、発音記号等）を含む
   - 深掘りチャットは項目ごとに独立したセッション
   - トリガー: AIサービスが呼び出された

## 時間的制約

### ⏰ タイムアウト

- テスト1問あたり30秒
- 1ポモドーロ25分
- AI応答待ち最大10秒

### 📅 スケジュール

- 日次: 学習統計の集計
- 週次: 領域別進捗の評価
- 月次: IELTSスコア推定の更新

## 発見された境界

### 🔲 潜在的な境界づけられたコンテキスト

1. **User Context**
   - Firebase認証統合
   - ユーザープロファイル管理
   - 学習設定管理

2. **Learning Context**
   - テストセッション管理
   - 反応時間記録
   - 「覚えた」判定
   - 復習スケジューリング

3. **Vocabulary Context**
   - グローバル辞書管理
   - AI語句情報生成
   - ユーザー別学習リスト

4. **AI Integration Context**
   - OpenAI/Gemini API統合
   - 深掘りチャット管理
   - テストカスタマイズ

5. **Progress Context**
   - 学習統計集計
   - 領域別評価（R/W/L/S）
   - IELTSスコア推定

## 次のステップ

1. ユビキタス言語の定義
2. 各コンテキストの詳細設計
3. コンテキスト間の統合パターン決定

## Read Model とプロジェクション 📊

### CQRS/Event Sourcing の適用

Progress Context と Vocabulary Context では、CQRS/Event Sourcing パターンを採用し、
イベントから様々な Read Model を生成する。

### Progress Context の Read Model

#### DailyStatsProjection

```
[学習イベント] → [日別統計として集計] → [DailyStats Read Model]
                                            ↓
                                    - 学習項目数
                                    - 正答率
                                    - 学習時間
                                    - 達成スコア
```

#### CategoryProgressProjection

```
[正誤判定イベント] → [カテゴリ別に集計] → [CategoryProgress Read Model]
                                                ↓
                                        - CEFR レベル分布
                                        - カテゴリ別正答率
                                        - 難易度分布
```

#### UserSummaryProjection

```
[全イベント] → [ユーザー別サマリー生成] → [UserSummary Read Model]
                                                ↓
                                        - 総学習時間
                                        - 習得項目数
                                        - 進捗スコア (0-100)
                                        - 連続学習日数
```

### Vocabulary Context の Read Model

#### VocabularyReadModel

```
[語彙イベント] → [基本情報として投影] → [Vocabulary Read Model]
                                            ↓
                                    - エントリー一覧
                                    - 項目詳細
                                    - 統計情報
```

#### VocabularySearchIndex

```
[語彙イベント] → [検索インデックスに投影] → [Meilisearch Index]
                                                    ↓
                                            - 全文検索
                                            - ファセット検索
                                            - オートコンプリート
```

### プロジェクションのタイミング

#### リアルタイム投影

- DailyStats（今日の統計）
- 基本的な Read Model 更新

#### バッチ投影（5分間隔）

- CategoryProgress
- 検索インデックス更新

#### 遅延投影（アクセス時）

- 月次トレンド
- 複雑な統計計算

## 更新履歴

- 2025-08-03: Read Model とプロジェクションのセクションを追加
- 2025-07-27: ドメインエキスパートとの対話に基づき作成
